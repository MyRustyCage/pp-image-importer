<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>URL Image Import Test</title>
    <style>
      body {
        font-family: system-ui, Arial, sans-serif;
        padding: 12px;
      }
      input[type="url"] {
        width: 100%;
        padding: 8px;
        margin-bottom: 8px;
        box-sizing: border-box;
      }
      button {
        width: 100%;
        padding: 10px;
      }
      #status {
        margin-top: 10px;
        font-size: 12px;
        white-space: pre-wrap;
      }
      .ok {
        color: #1a7f37;
      }
      .err {
        color: #b42318;
      }
    </style>
  </head>
  <body>
    <h3>Import Image from URL</h3>
    <input
      id="imageUrl"
      type="url"
      placeholder="https://example.com/image.jpg"
    />
    <button id="importBtn">Import</button>
    <div id="status"></div>

    <script>
      const statusEl = document.getElementById("status");
      const btn = document.getElementById("importBtn");

      function setStatus(msg, ok = true) {
        statusEl.textContent = msg;
        statusEl.className = ok ? "ok" : "err";
      }

      btn.addEventListener("click", async () => {
        let url = document.getElementById("imageUrl").value.trim();
        if (!url) {
          setStatus("Please enter an image URL.", false);
          return;
        }

        // Auto-prefix https
        if (!/^https?:\/\//.test(url)) {
          url = `https://${url}`;
        }

        setStatus("Fetching image...");

        try {
          // Fetch in UI context (no auth headers!)
          const response = await fetch(url, { mode: "cors" });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          setStatus("Converting image data...");

          // Convert to ArrayBuffer
          const arrayBuffer = await response.arrayBuffer();
          const uint8Array = new Uint8Array(arrayBuffer);

          // Detect MIME type
          let mime = "image/png";
          if (
            uint8Array[0] === 0xff &&
            uint8Array[1] === 0xd8 &&
            uint8Array[2] === 0xff
          ) {
            mime = "image/jpeg";
          } else if (
            uint8Array[0] === 0x47 &&
            uint8Array[1] === 0x49 &&
            uint8Array[2] === 0x46
          ) {
            mime = "image/gif";
          } else if (
            uint8Array[0] === 0x89 &&
            uint8Array[1] === 0x50 &&
            uint8Array[2] === 0x4e &&
            uint8Array[3] === 0x47
          ) {
            mime = "image/png";
          }

          setStatus(
            `Uploading ${uint8Array.byteLength.toLocaleString()} bytes...`
          );

          // Send to plugin as Array (Uint8Array can't be cloned to plugin context)
          parent.postMessage(
            {
              pluginMessage: {
                type: "import-image-data",
                imageData: Array.from(uint8Array),
                mime: mime,
              },
            },
            "*"
          );
        } catch (err) {
          setStatus(
            `Failed: ${err.message}\n\nTry:\n- https://picsum.photos/600/400\n- https://placehold.co/600x400.png`,
            false
          );
        }
      });

      window.addEventListener("message", (event) => {
        const msg = event.data && event.data.pluginMessage;
        if (!msg) return;

        if (msg.type === "import-success") {
          setStatus("Image imported successfully!", true);
        } else if (msg.type === "import-error") {
          setStatus(msg.detail || "Unknown error", false);
        }
      });
    </script>
  </body>
</html>
