<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>URL Image Import Test</title>
    <style>
      body {
        font-family: system-ui, Arial, sans-serif;
        padding: 12px;
      }
      input[type="url"] {
        width: 100%;
        padding: 8px;
        margin-bottom: 8px;
        box-sizing: border-box;
      }
      button {
        width: 100%;
        padding: 10px;
      }
      #status {
        margin-top: 10px;
        font-size: 12px;
        white-space: pre-wrap;
      }
      .ok {
        color: #1a7f37;
      }
      .err {
        color: #b42318;
      }
    </style>
  </head>
  <body>
    <h3>Import Image from URL</h3>
    <input
      id="imageUrl"
      type="url"
      placeholder="https://example.com/image.jpg"
    />
    <button id="importBtn">Import</button>
    <div id="status"></div>

    <script>
      const statusEl = document.getElementById("status");
      const btn = document.getElementById("importBtn");

      function setStatus(msg, ok = true) {
        statusEl.textContent = msg;
        statusEl.className = ok ? "ok" : "err";
      }

      async function fetchImage(url) {
        // Try direct fetch first
        try {
          console.log("[UI] Trying direct fetch:", url);
          const response = await fetch(url, { mode: "cors" });
          if (response.ok) {
            console.log("[UI] Direct fetch succeeded");
            return response;
          }
          throw new Error(`HTTP ${response.status}`);
        } catch (directError) {
          console.log("[UI] Direct fetch failed:", directError.message);
          setStatus("Direct fetch failed, trying CORS proxy...");

          // Fallback to CORS proxy
          const corsProxies = [
            `https://corsproxy.io/?${encodeURIComponent(url)}`,
            `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
            `https://cors-anywhere.herokuapp.com/${url}`,
          ];

          for (const proxyUrl of corsProxies) {
            try {
              console.log("[UI] Trying proxy:", proxyUrl);
              const response = await fetch(proxyUrl);
              if (response.ok) {
                console.log("[UI] Proxy fetch succeeded");
                setStatus("Fetched via CORS proxy...");
                return response;
              }
            } catch (proxyError) {
              console.log("[UI] Proxy failed:", proxyError.message);
              continue;
            }
          }

          throw new Error(
            "All fetch methods failed. Server may block cross-origin requests."
          );
        }
      }

      btn.addEventListener("click", async () => {
        let url = document.getElementById("imageUrl").value.trim();
        if (!url) {
          setStatus("Please enter an image URL.", false);
          return;
        }

        // Auto-prefix https
        if (!/^https?:\/\//.test(url)) {
          url = `https://${url}`;
        }

        setStatus("Fetching image...");

        try {
          // Fetch with fallback
          const response = await fetchImage(url);

          setStatus("Converting image data...");

          // Convert to ArrayBuffer
          const arrayBuffer = await response.arrayBuffer();
          const uint8Array = new Uint8Array(arrayBuffer);

          // Detect MIME type
          let mime = "image/png";
          if (
            uint8Array[0] === 0xff &&
            uint8Array[1] === 0xd8 &&
            uint8Array[2] === 0xff
          ) {
            mime = "image/jpeg";
          } else if (
            uint8Array[0] === 0x47 &&
            uint8Array[1] === 0x49 &&
            uint8Array[2] === 0x46
          ) {
            mime = "image/gif";
          } else if (
            uint8Array[0] === 0x89 &&
            uint8Array[1] === 0x50 &&
            uint8Array[2] === 0x4e &&
            uint8Array[3] === 0x47
          ) {
            mime = "image/png";
          } else if (
            uint8Array[0] === 0x3c &&
            uint8Array[1] === 0x73 &&
            uint8Array[2] === 0x76 &&
            uint8Array[3] === 0x67
          ) {
            mime = "image/svg+xml";
          }

          setStatus(
            `Uploading ${uint8Array.byteLength.toLocaleString()} bytes (${mime})...`
          );

          // Send to plugin as Array
          parent.postMessage(
            {
              pluginMessage: {
                type: "import-image-data",
                imageData: Array.from(uint8Array),
                mime: mime,
              },
            },
            "*"
          );
        } catch (err) {
          setStatus(
            `Failed: ${err.message}\n\nWorking examples:\n- https://picsum.photos/600/400\n- https://placehold.co/600x400.png`,
            false
          );
        }
      });

      window.addEventListener("message", (event) => {
        const msg = event.data && event.data.pluginMessage;
        if (!msg) return;

        if (msg.type === "import-success") {
          setStatus("Image imported successfully!", true);
        } else if (msg.type === "import-error") {
          setStatus(msg.detail || "Unknown error", false);
        }
      });
    </script>
  </body>
</html>
